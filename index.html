<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Availability</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --green: #4caf50;
            --yellow: #ffc107;
            --selected-yes: var(--green);
            --selected-maybe: var(--yellow);
        }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 0; 
            background-color: var(--bg-color); color: var(--text-color);
            user-select: none;
        }
        .container { display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px; text-align: center; border-bottom: 1px solid var(--secondary-bg); }
        
        /* --- SETUP FORM STYLES --- */
        .setup-wrapper { padding: 20px; display: none; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .form-input {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            font-size: 16px; background-color: var(--secondary-bg); color: var(--text-color);
            box-sizing: border-box;
        }
        .mode-select { display: flex; gap: 10px; }
        .mode-option {
            flex: 1; padding: 10px; text-align: center; border: 1px solid var(--button-color);
            border-radius: 8px; cursor: pointer; color: var(--button-color);
        }
        .mode-option.active { background-color: var(--button-color); color: white; }

        /* --- NAVIGATION --- */
        .nav-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid var(--secondary-bg);
        }
        .nav-btn {
            background: none; border: none; font-size: 20px; cursor: pointer; color: var(--button-color);
            padding: 5px 15px;
        }
        .nav-title { font-weight: bold; font-size: 15px; }

        /* --- ACTIONS TOOLBAR --- */
        .actions-toolbar {
            display: flex; justify-content: center; gap: 10px;
            padding: 10px; background-color: var(--secondary-bg);
            border-bottom: 1px solid #ddd;
        }
        .action-btn {
            padding: 8px 12px; border: 1px solid var(--button-color);
            background-color: var(--bg-color); color: var(--button-color);
            border-radius: 6px; font-size: 13px; cursor: pointer;
        }
        .action-btn:active { background-color: var(--secondary-bg); }

        /* --- TIME GRID STYLES --- */
        .time-grid-wrapper { flex-grow: 1; overflow: auto; display: none; }
        .grid-container {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 1px; background-color: var(--secondary-bg); border-top: 1px solid var(--secondary-bg);
            min-width: 320px;
        }
        .header-cell {
            background-color: var(--bg-color); font-weight: bold; font-size: 11px; text-align: center;
            padding: 10px 2px; position: sticky; top: 0; z-index: 20;
            display: flex; flex-direction: column; justify-content: center;
            cursor: pointer;
        }
        .header-date { font-size: 9px; opacity: 0.7; font-weight: normal; }
        .time-col {
            background-color: var(--bg-color); font-size: 11px; text-align: right;
            padding-right: 8px; position: sticky; left: 0; z-index: 10;
            cursor: pointer;
        }
        .slot { height: 35px; background-color: var(--bg-color); position: relative; }

        /* --- CALENDAR STYLES --- */
        .calendar-wrapper { flex-grow: 1; overflow: auto; padding: 15px; display: none; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .cal-day-header {
            text-align: center; font-size: 11px; color: var(--text-color); opacity: 0.6;
            margin-bottom: 5px; cursor: pointer;
        }
        .cal-day {
            aspect-ratio: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--secondary-bg);
            border-radius: 8px; font-size: 14px; cursor: pointer; position: relative; overflow: hidden;
        }
        .cal-day.empty { background-color: transparent; cursor: default; }
        
        /* --- SHARED INTERACTIVE --- */
        .selected-yes { background-color: var(--selected-yes) !important; color: white; }
        .selected-maybe { background-color: var(--selected-maybe) !important; color: black; }
        
        .selected-yes::after, .selected-maybe::after {
            content: '✓'; position: absolute; top: 2px; right: 2px; font-size: 10px;
            font-weight: bold; color: inherit;
        }

        #loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); display: none; 
            align-items: center; justify-content: center; color: white;
            z-index: 100;
        }
        #error-msg {
            color: red; text-align: center; display: none; padding: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <header id="main-header">
        <h2 id="event-title">Loading...</h2>
        <p class="hint" id="hint-text">1 Tap: Available, 2 Taps: Maybe</p>
    </header>

    <div id="error-msg">
        <p id="error-text">Failed to load event.</p>
        <button onclick="window.location.reload()" class="nav-btn" style="border: 1px solid;">Retry</button>
    </div>

    <!-- SETUP FORM -->
    <div id="setup-view" class="setup-wrapper">
        <div class="form-group">
            <label class="form-label">Event Name</label>
            <input type="text" id="setup-name" class="form-input" placeholder="e.g. Team Dinner">
        </div>

        <div class="form-group">
            <label class="form-label">Mode</label>
            <div class="mode-select">
                <div class="mode-option active" id="mode-time" onclick="setSetupMode('time')">Time Slots</div>
                <div class="mode-option" id="mode-date" onclick="setSetupMode('date')">Whole Days</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Start Date (Optional)</label>
            <input type="date" id="setup-start" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">End Date (Optional)</label>
            <input type="date" id="setup-end" class="form-input">
        </div>
    </div>

    <!-- MODE 1: TIME GRID -->
    <div id="time-view" class="time-grid-wrapper">
        <div class="nav-header">
            <button class="nav-btn" id="prev-week">◀</button>
            <span class="nav-title" id="week-label">Week View</span>
            <button class="nav-btn" id="next-week">▶</button>
        </div>

        <!-- TOOLBAR for Time View -->
        <div class="actions-toolbar">
            <button class="action-btn" onclick="selectAll('time')">✅ Mark Week Free</button>
            <button class="action-btn" onclick="clearAll('time')">❌ Clear Week</button>
        </div>

        <div id="grid" class="grid-container"></div>
    </div>

    <!-- MODE 2: CALENDAR GRID -->
    <div id="date-view" class="calendar-wrapper">
        <div class="nav-header">
            <button class="nav-btn" id="prev-month">◀</button>
            <span class="nav-title" id="month-label">Month Year</span>
            <button class="nav-btn" id="next-month">▶</button>
        </div>

        <!-- TOOLBAR for Calendar View -->
        <div class="actions-toolbar">
            <button class="action-btn" onclick="selectAll('date')">✅ Mark Month Free</button>
            <button class="action-btn" onclick="clearAll('date')">❌ Clear Month</button>
        </div>

        <div id="calendar" class="calendar-grid">
            <div class="cal-day-header">Sun</div><div class="cal-day-header">Mon</div>
            <div class="cal-day-header">Tue</div><div class="cal-day-header">Wed</div>
            <div class="cal-day-header">Thu</div><div class="cal-day-header">Fri</div>
            <div class="cal-day-header">Sat</div>
        </div>
    </div>
</div>

<div id="loader">Processing...</div>

<script>
    // Global Error Handler
    window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('error-msg').style.display = 'block';
        document.getElementById('error-text').innerText = "JS Error: " + message;
        return false;
    };

    const tg = window.Telegram.WebApp;
    tg.expand(); 

    const BACKEND_API_URL = "";

    // --- INITIALIZATION ---
    const urlParams = new URLSearchParams(window.location.search);
    const modeParam = urlParams.get('mode');
    const chatId = urlParams.get('chatId');
    const eventId = urlParams.get('eventId');
    const setupId = urlParams.get('setupId');

    // Shared State
    let mode = modeParam || 'time';
    let eventName = "Event";
    const userId = tg.initDataUnsafe.user?.id?.toString() || 'anon';
    const username = tg.initDataUnsafe.user?.username || "";

    // State Map: slotId -> 'yes' | 'maybe'
    const selectedSlots = new Map();
    
    let isDragging = false;
    let dragType = 'yes'; // 'yes' or 'maybe' or 'clear'

    let currentMonthDate = new Date();
    let currentWeekStart = new Date();
    currentMonthDate.setHours(0,0,0,0);
    currentWeekStart.setHours(0,0,0,0);
    const day = currentWeekStart.getDay();
    const diff = currentWeekStart.getDate() - day + (day === 0 ? -6 : 1);
    currentWeekStart.setDate(diff);

    let globalSlotScores = {}; // Sum of weights
    let globalTotalVoters = 0;

    // Setup State
    let setupModeVal = 'time';

    // Route logic
    if (modeParam === 'setup') {
        initSetup();
    } else {
        initVoting();
    }

    // --- SETUP FUNCTIONS ---
    function initSetup() {
        document.getElementById('setup-view').style.display = 'block';
        document.getElementById('event-title').innerText = "Create Event";
        
        tg.MainButton.setText("CREATE EVENT");
        tg.MainButton.show();

        tg.MainButton.onClick(async () => {
            const name = document.getElementById('setup-name').value;
            const start = document.getElementById('setup-start').value;
            const end = document.getElementById('setup-end').value;
            
            if (!name) {
                tg.showAlert("Please enter an event name!");
                return;
            }

            const data = {
                name: name,
                mode: setupModeVal,
                start_date: start || null,
                end_date: end || null,
                chat_id: chatId,
                setup_id: setupId
            };
            
            document.getElementById('loader').style.display = 'flex';
            tg.MainButton.hide();

            try {
                const res = await fetch(`${BACKEND_API_URL}/create_event`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.status === 'success') {
                    tg.close();
                } else {
                    tg.showAlert("Error creating event: " + (result.message || "Unknown error"));
                    document.getElementById('loader').style.display = 'none';
                    tg.MainButton.show();
                }
            } catch (e) {
                console.error(e);
                tg.showAlert("Network Error. Please try again.");
                document.getElementById('loader').style.display = 'none';
                tg.MainButton.show();
            }
        });
    }

    function setSetupMode(m) {
        setupModeVal = m;
        document.getElementById('mode-time').classList.toggle('active', m === 'time');
        document.getElementById('mode-date').classList.toggle('active', m === 'date');
    }

    // --- VOTING FUNCTIONS ---

    async function loadData() {
        if (!eventId) throw new Error("Missing Event ID");
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        try {
            const res = await fetch(`${BACKEND_API_URL}/get_event_data?eventId=${eventId}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            if (!res.ok) throw new Error("HTTP " + res.status);
            return await res.json();
        } catch (e) {
            clearTimeout(timeoutId);
            throw e;
        }
    }

    function initVoting() {
        loadData().then(data => {
            if (data && !data.error) {
                eventName = data.name;
                mode = data.mode;
                document.getElementById('event-title').innerText = eventName;

                if (data.start_date) {
                    const start = new Date(data.start_date);
                    currentMonthDate = new Date(start);
                    currentWeekStart = new Date(start);
                    const d = currentWeekStart.getDay();
                    const delta = currentWeekStart.getDate() - d + (d === 0 ? -6 : 1);
                    currentWeekStart.setDate(delta);
                }

                const votes = data.votes || {};
                globalSlotScores = {};
                let totalVoters = 0;
                const voters = new Set();

                // Parse Votes (handle Legacy List and New Dict)
                Object.keys(votes).forEach(uid => {
                    voters.add(uid);
                    let userSlots = votes[uid];
                    // Handle wrapped object if needed (for username)
                    if (userSlots.slots) {
                        userSlots = userSlots.slots;
                    }

                    if (Array.isArray(userSlots)) {
                        // Legacy: List of strings (assumed 'yes')
                        userSlots.forEach(slot => {
                            globalSlotScores[slot] = (globalSlotScores[slot] || 0) + 1.0;
                            if (uid === userId) selectedSlots.set(slot, 'yes');
                        });
                    } else if (typeof userSlots === 'object') {
                        // New: Dict {slotId: type}
                        Object.entries(userSlots).forEach(([slot, type]) => {
                            let weight = (type === 'yes') ? 1.0 : 0.5;
                            globalSlotScores[slot] = (globalSlotScores[slot] || 0) + weight;
                            if (uid === userId) selectedSlots.set(slot, type);
                        });
                    }
                });
                globalTotalVoters = voters.size;

                initViews();

                tg.MainButton.setText("SUBMIT");
                tg.MainButton.show();
                tg.MainButton.onClick(submitVote);
            } else {
                showError("Event data invalid or not found.");
            }
        }).catch(err => {
            console.error(err);
            showError("Failed to load event. " + err.message);
        });
    }
    
    function showError(msg) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('event-title').innerText = "Error";
        document.getElementById('hint-text').style.display = 'none';
        document.getElementById('error-msg').style.display = 'block';
        document.getElementById('error-text').innerText = msg;
    }

    function initViews() {
        if (mode === 'date') {
            initCalendar();
        } else {
            initTimeGrid();
        }
    }

    async function submitVote() {
        if (selectedSlots.size === 0) {
            tg.showAlert("Please select at least one option!");
            return;
        }
        const payload = {
            eventId: eventId,
            userId: userId,
            username: username,
            slots: Object.fromEntries(selectedSlots)
        };
        document.getElementById('loader').style.display = 'flex';
        try {
            await fetch(`${BACKEND_API_URL}/submit_availability`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            tg.close();
        } catch (e) {
            document.getElementById('loader').style.display = 'none';
            tg.showAlert("Error saving. Check connection.");
        }
    }

    // --- BULK OPERATIONS ---
    function selectAll(currentMode) {
        // Find all visible slots/days
        const selector = currentMode === 'time' ? '#grid .slot' : '#calendar .cal-day';
        const elements = document.querySelectorAll(selector);

        elements.forEach(el => {
            if (!el.classList.contains('empty')) {
                selectedSlots.set(el.dataset.id, 'yes');
                updateSlotVisual(el, el.dataset.id);
            }
        });
        tg.HapticFeedback.impactOccurred('light');
    }

    function clearAll(currentMode) {
        const selector = currentMode === 'time' ? '#grid .slot' : '#calendar .cal-day';
        const elements = document.querySelectorAll(selector);

        elements.forEach(el => {
            if (!el.classList.contains('empty')) {
                selectedSlots.delete(el.dataset.id);
                updateSlotVisual(el, el.dataset.id);
            }
        });
        tg.HapticFeedback.impactOccurred('light');
    }

    // --- CALENDAR LOGIC ---
    function initCalendar() {
        document.getElementById('date-view').style.display = 'block';
        renderMonth();
        document.getElementById('prev-month').onclick = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); renderMonth(); };
        document.getElementById('next-month').onclick = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); renderMonth(); };
    }

    function renderMonth() {
        const year = currentMonthDate.getFullYear();
        const month = currentMonthDate.getMonth();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('month-label').innerText = `${monthNames[month]} ${year}`;
        const calGrid = document.getElementById('calendar');
        const oldDays = calGrid.querySelectorAll('.cal-day, .empty');
        oldDays.forEach(el => el.remove());
        const firstDay = new Date(year, month, 1);
        const startingDayOfWeek = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < startingDayOfWeek; i++) {
            const empty = document.createElement('div'); empty.className = 'cal-day empty'; calGrid.appendChild(empty);
        }
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const dateStr = dateObj.toISOString().split('T')[0];
            const cell = document.createElement('div');
            cell.className = 'cal-day'; cell.dataset.id = dateStr; cell.innerHTML = `<span>${d}</span>`;
            applyHeatmap(cell, dateStr);
            updateSlotVisual(cell, dateStr);
            attachDragEvents(cell);
            calGrid.appendChild(cell);
        }
    }

    // --- TIME GRID LOGIC ---
    function initTimeGrid() {
        document.getElementById('time-view').style.display = 'block';
        renderTimeGrid();
        document.getElementById('prev-week').onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); renderTimeGrid(); };
        document.getElementById('next-week').onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); renderTimeGrid(); };
    }

    function renderTimeGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const dates = [];
        const corner = document.createElement('div'); corner.className = 'header-cell'; grid.appendChild(corner);

        for (let i = 0; i < 7; i++) {
            const d = new Date(currentWeekStart); d.setDate(currentWeekStart.getDate() + i); dates.push(d);
            const h = document.createElement('div'); h.className = 'header-cell';
            const dateStr = `${d.getDate()}/${d.getMonth()+1}`;
            h.innerHTML = `<span>${days[i]}</span><span class="header-date">${dateStr}</span>`;

            // Bulk Select Column
            h.onclick = () => bulkSelect('col', i, dates);

            grid.appendChild(h);
        }

        const endWeek = new Date(dates[6]);
        const startStr = `${dates[0].getDate()} ${dates[0].toLocaleString('default', {month:'short'})}`;
        const endStr = `${endWeek.getDate()} ${endWeek.toLocaleString('default', {month:'short'})}`;
        document.getElementById('week-label').innerText = `${startStr} - ${endStr}`;

        for (let h = 8; h < 22; h++) {
            const timeCol = document.createElement('div'); timeCol.className = 'time-col'; timeCol.innerText = `${h}:00`;

            // Bulk Select Row
            timeCol.onclick = () => bulkSelect('row', h, dates);

            grid.appendChild(timeCol);
            for (let i = 0; i < 7; i++) {
                const dateStr = dates[i].toISOString().split('T')[0];
                const slotId = `${dateStr}-${h}`;
                const slot = document.createElement('div'); slot.className = 'slot'; slot.dataset.id = slotId;
                applyHeatmap(slot, slotId);
                updateSlotVisual(slot, slotId);
                attachDragEvents(slot);
                grid.appendChild(slot);
            }
        }
    }

    function bulkSelect(type, index, dates) {
        // Toggle entire row/col. Logic: If majority selected, clear. Else fill 'yes'.
        let ids = [];
        if (type === 'col') {
            const dateStr = dates[index].toISOString().split('T')[0];
            for (let h = 8; h < 22; h++) ids.push(`${dateStr}-${h}`);
        } else {
            for (let i = 0; i < 7; i++) {
                const dateStr = dates[i].toISOString().split('T')[0];
                ids.push(`${dateStr}-${index}`);
            }
        }

        // Count selected
        let count = 0;
        ids.forEach(id => { if (selectedSlots.has(id)) count++; });

        const action = (count > ids.length / 2) ? 'clear' : 'yes';

        ids.forEach(id => {
            if (action === 'clear') selectedSlots.delete(id);
            else selectedSlots.set(id, 'yes');

            // Update Visual
            const el = document.querySelector(`.slot[data-id="${id}"]`);
            if (el) updateSlotVisual(el, id);
        });
    }

    function applyHeatmap(el, id) {
        if (!globalTotalVoters) return;
        const score = globalSlotScores[id] || 0;
        if (score > 0) {
            const saturation = score / globalTotalVoters;
            el.style.backgroundColor = `rgba(76, 175, 80, ${saturation})`;
        }
    }

    function updateSlotVisual(el, id) {
        el.classList.remove('selected-yes', 'selected-maybe');
        if (selectedSlots.has(id)) {
            const type = selectedSlots.get(id);
            if (type === 'yes') el.classList.add('selected-yes');
            else if (type === 'maybe') el.classList.add('selected-maybe');
        }
    }

    // --- DRAG LOGIC ---
    function attachDragEvents(el) {
        el.addEventListener('mousedown', startDrag); el.addEventListener('mouseenter', doDrag);
        el.addEventListener('touchstart', startTouch, {passive: false}); el.addEventListener('touchmove', moveTouch, {passive: false});
    }
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('touchend', () => isDragging = false);

    function cycleState(id) {
        if (!selectedSlots.has(id)) return 'yes';
        if (selectedSlots.get(id) === 'yes') return 'maybe';
        return 'clear';
    }

    function startDrag(e) {
        if(e.cancelable) e.preventDefault();
        isDragging = true;
        const cell = e.currentTarget;
        const id = cell.dataset.id;

        // Determine drag type based on cycle of clicked cell
        dragType = cycleState(id);

        applyState(cell, id, dragType);
    }

    function doDrag(e) {
        if (isDragging) {
            const cell = e.currentTarget;
            applyState(cell, cell.dataset.id, dragType);
        }
    }

    function startTouch(e) {
        if(e.cancelable) e.preventDefault();
        isDragging = true;
        const el = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
        const cell = el?.closest('.cal-day, .slot');
        if (cell) {
            const id = cell.dataset.id;
            dragType = cycleState(id);
            applyState(cell, id, dragType);
        }
    }

    function moveTouch(e) {
        if(e.cancelable) e.preventDefault();
        if (!isDragging) return;
        const el = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
        const cell = el?.closest('.cal-day, .slot');
        if (cell) applyState(cell, cell.dataset.id, dragType);
    }

    function applyState(el, id, type) {
        if (!el || el.classList.contains('empty')) return;
        if (type === 'clear') {
            selectedSlots.delete(id);
        } else {
            selectedSlots.set(id, type);
        }
        updateSlotVisual(el, id);
    }
</script>
</body>
</html>
